import streamlit as st
import pymysql
import json
from datetime import datetime
from openai import OpenAI
import re
from zoneinfo import ZoneInfo
import fitz  # PyMuPDF
import numpy as np
import os
import hashlib
import time

# ===== Configuration =====
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
MODEL = "gpt-4o"
BASE_DIR = os.path.join(os.getcwd(), "Textbook_2025")
PDF_MAP = {
    "ê³¼í•™2(ë¹„ìƒ)": ["2025_8th_Sci_V.pdf"],
    "ê³¼í•™3(ë¹„ìƒ)": ["2025_9th_Sci_V.pdf"],
    "í†µí•©ê³¼í•™(ë™ì•„)": ["2025_10th_Sci_D.pdf"],
    "í†µí•©ê³¼í•™(ë¹„ìƒ)": ["2025_10th_Sci_V.pdf"],
}
SUBJECTS = {
    "ì¤‘2": ["ê³¼í•™2(ë¹„ìƒ)"],
    "ì¤‘3": ["ê³¼í•™3(ë¹„ìƒ)"],
    "ê³ 1": ["í†µí•©ê³¼í•™(ë™ì•„)", "í†µí•©ê³¼í•™(ë¹„ìƒ)"],
}

# Initial prompts
COMMON_PROMPT = (
    "ë‹¹ì‹ ì€ ì¤‘ê³ ë“±í•™ìƒë“¤ì˜ í•™ìŠµì„ ë•ëŠ” AI íŠœí„°ì…ë‹ˆë‹¤.\n"
    "ë‹µí•  ìˆ˜ ì—†ëŠ” ì •ë³´(ì‹œí—˜ ë²”ìœ„, ì‹œí—˜ ë‚ ì§œ ë“±)ì— ëŒ€í•´ì„  ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ë„ë¡ ì•ˆë‚´í•˜ì„¸ìš”.\n"
    "ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ë§íˆ¬ë¡œ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”. í•™ìƒì´ í¸í•˜ê²Œ ëŠë‚„ ìˆ˜ ìˆë„ë¡ ìƒí™©ì— ë§ëŠ” ë‹¤ì–‘í•œ ì´ëª¨ì§€, ëŠë‚Œí‘œ ë“±ì„ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©í•˜ì„¸ìš”.\n"
    "ë‹¹ì‹ ì€ í•™ìƒë“¤ì´ ì§ˆë¬¸í•˜ëŠ” ë‚´ìš©ì— ë‹µí•˜ê±°ë‚˜, ë¬¸ì œë¥¼ ë‚´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•™ìƒ ìˆ˜ì¤€ì— ë§ê²Œ ì°¨ê·¼ì°¨ê·¼ ì„¤ëª…í•´ ì£¼ì„¸ìš”.\n"
    "ë‹¹ì‹ ì€ ì² ì €í•˜ê²Œ êµê³¼ì„œ ë‚´ìš©ì— ê·¼ê±°í•˜ì—¬ ì„¤ëª…ê³¼ ë¬¸í•­ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.\n"
    "ëª¨ë“  ìˆ˜ì‹ì€ ë°˜ë“œì‹œ LaTeX í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³  '@@@@@'ë¡œ ê°ì‹¸ì£¼ì„¸ìš”. ìˆ˜ì‹ ì•ë’¤ì—ëŠ” ë°˜ë“œì‹œ ë¹ˆ ì¤„ë¡œ êµ¬ë¶„í•´ ì£¼ì„¸ìš”. ì´ ê·œì¹™ì€ ì–´ë–¤ ê²½ìš°ì—ë„ ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤. ì˜ˆì‹œ:\n\n@@@@@\nE_p = 9.8 \\times m \\times h\n@@@@@\n\n"
    "ì ˆëŒ€ë¡œ ë¬¸ì¥ ì¤‘ê°„ì— LaTeX í˜•ì‹ì´ ë“¤ì–´ê°€ì„  ì•ˆ ë©ë‹ˆë‹¤. LaTex ì‚¬ìš©ì€ ë°˜ë“œì‹œ ì¤„ë°”ê¿ˆí•˜ê³ , LaTex ì•ë’¤ë¥¼ ê°ê° @ ê¸°í˜¸ 5ê°œë¡œ ê°ì‹¸ì•¼ í•©ë‹ˆë‹¤.\ "
    "í‹€ë¦° í‘œí˜„ ì˜ˆì‹œ: ì–´ë–¤ ë¬¼ì²´ì˜ ì§ˆëŸ‰ì´ 2kgì´ê³  ë†’ì´ê°€ 10mì¼ ë•Œ ìœ„ì¹˜ì—ë„ˆì§€ëŠ”((E_p = 9.8 \\times m \\times h))ì…ë‹ˆë‹¤.\n"
    "ë§ëŠ” í‘œí˜„ ì˜ˆì‹œ: ì–´ë–¤ ë¬¼ì²´ì˜ ì§ˆëŸ‰ì´ 2kgì´ê³  ë†’ì´ê°€ 10mì¼ ë•Œ ìœ„ì¹˜ì—ë„ˆì§€ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n\n@@@@@\nE_p = 9.8 \\times m \\times h\n@@@@@\n\n"
    "ë§Œì•½ LaTexë¥¼ ì¤„ë°”ê¿ˆ ì—†ì´ ì‚¬ìš©í•´ì•¼ë§Œ í•˜ëŠ” ìƒí™©ì´ë¼ë©´, LaTexê°€ ì•„ë‹Œ ê¸€ë¡œ ì“°ì„¸ìš”. \ní‹€ë¦° í‘œí˜„ ì˜ˆì‹œ: ìœ„ì¹˜ì—ë„ˆì§€ëŠ” 9.8 \\times m \\times hì…ë‹ˆë‹¤. \në§ëŠ” í‘œí˜„ ì˜ˆì‹œ: ìœ„ì¹˜ì—ë„ˆì§€ëŠ” 9.8Ã—mÃ—hì…ë‹ˆë‹¤. LaTexë¥¼ ì“°ë ¤ë©´ ë°˜ë“œì‹œ ì•ë’¤ë¡œ ì¤„ë°”ê¿ˆí•´ì•¼ í•©ë‹ˆë‹¤.\n"
#    "ê·¸ë¦¼ì„ ì¶œë ¥í•´ì•¼ í•˜ëŠ” ê²½ìš°, ë§í¬ë¥¼ ë‹µë³€ì— í¬í•¨í•˜ë©´ ìë™ìœ¼ë¡œ ê·¸ë¦¼ì´ ì¶œë ¥ë©ë‹ˆë‹¤. ë”°ë¡œ í•˜ì´í¼ë§í¬ë¥¼ ë§Œë“¤ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.\n"
#    "ëŒ€í™” ì˜ˆì‹œ: ëˆˆì˜ êµ¬ì¡°ëŠ” ì•„ë˜ ê·¸ë¦¼ì„ ì°¸ê³ í•˜ì„¸ìš”. \n\n https://i.imgur.com/BIFjdBj.png \n"
    "í•™ìƒì´ ë¬¸ì œë¥¼ ë‚´ë‹¬ë¼ê³  í•˜ë©´, ì–´ë–¤ ë‹¨ì› ë˜ëŠ” ë‚´ìš©ì—ì„œ ë¬¸ì œ ë‚´ì£¼ê¸¸ ì›í•˜ëŠ”ì§€ ë¬¼ì–´ë³´ì„¸ìš”. í•œ ë²ˆì— ì—¬ëŸ¬ ê°œì˜ ë¬¸ì œë¥¼ ë‹¬ë¼ëŠ” ëª…ì‹œì ì¸ ìš”ì²­ì´ ì—†ë‹¤ë©´, í•˜ë‚˜ì˜ ëŒ€í™”ì—ì„œëŠ” í•œ ë¬¸ì œë§Œ ë‚´ì„¸ìš”.\n"
    "ë§Œì•½ í•™ìƒì´ ì–´ë ¤ìš´ ë¬¸ì œ, ë‚œì´ë„ ë†’ì€ ë¬¸ì œë¥¼ ë‹¬ë¼ê³  í•œë‹¤ë©´, ê°œì¸ë§ˆë‹¤ ì˜ í•˜ëŠ” ê²ƒê³¼ ë¶€ì¡±í•œ ê²ƒì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ì–´ë µë‹¤ê³  ëŠë¼ëŠ” ë¬¸í•­ë„ ê°œì¸ë³„ë¡œ ë‹¤ë¥´ë‹ˆ ë¬´ì—‡ì„ ì˜ í•˜ê³  ëª»í•˜ëŠ”ì§€ì— ëŒ€í•œ íŒŒì•…ì´ ìš°ì„ ë˜ì–´ì•¼ í•œë‹¤ê³  ì•ˆë‚´í•˜ì„¸ìš”. ë‚´ìš© ìì²´ê°€ ì´í•´ë˜ì§€ ì•ŠëŠ” ê²ƒì¸ì§€, ë‚´ìš©ì€ ì´í•´í•˜ì§€ë§Œ ë¬¸ì œì— ì ìš©í•˜ëŠ” ê²ƒì´ ì–´ë ¤ìš´ ê±´ì§€, í…ìŠ¤íŠ¸Â·ê·¸ë¦¼Â·í‘œÂ·ê·¸ë˜í”„ ë“±ì˜ ìë£Œ í•´ì„ì´ ì–´ë ¤ìš´ ê±´ì§€, ì„œìˆ í˜• ë‹µì„ ì“°ëŠ” ê²Œ ì–´ë ¤ìš´ ê±´ì§€ ë“± ë¬´ì—‡ì„ ì–´ë µë‹¤ê³  ëŠë¼ëŠ” ì§€ ìƒë‹´í•˜ë©° ì§„ë‹¨í•˜ì„¸ìš”.\n"
    "ìƒì„±í•œ ì‘ë‹µì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ í•™ìƒì´ ì´í•´í•˜ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ê°€ëŠ¥í•˜ë©´ ê°„ê²°í•˜ê²Œ ì‘ë‹µí•˜ì„¸ìš”.\n"
    "ê°€ë…ì„±ì´ ì¢‹ë„ë¡ ì ì ˆíˆ ì¤„ë°”ê¿ˆìœ¼ë¡œ í•˜ê³  ê°œì¡°ì‹ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”."
    "í’€ì´ ê³¼ì •ì´ ë³µì¡í•œ ë¬¸ì œì—ì„œ ë‹µì´ ë¶€ì •í™•í•œ ê²½ìš°ê°€ ì¢…ì¢… ìˆìœ¼ë‹ˆ, ë°˜ë“œì‹œ Chain-of-Thought ë°©ì‹ìœ¼ë¡œ ë‹¨ê³„ë³„ë¡œ ê²€í† í•˜ë©° ë‹µí•˜ì„¸ìš”. ê³„ì‚° ë¬¸ì œë‚˜ íŒë‹¨ì´ í•„ìš”í•œ ê²½ìš°, ì§§ê²Œ ì“°ë”ë¼ë„ ì¤‘ê°„ ê³¼ì •ì´ë‚˜ ì´ìœ ë¥¼ ê°„ë‹¨íˆ ë³´ì—¬ ì£¼ì„¸ìš”.\n"
    "í•™ìƒì´ ë¬¸ì œë¥¼ í‹€ë ¸ëŠ”ë° ë§í˜”ë‹¤ê³  í•˜ëŠ” ê²½ìš°ê°€ ë¹ˆë²ˆí•©ë‹ˆë‹¤. í’€ì´ë¥¼ ë¨¼ì € ê²€í† í•˜ê³  ì •ë‹µ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ì„¸ìš”.\n"
    "í•™ìƒì´ ë¬¸ì œë¥¼ í‹€ë ¸ì„ ê²½ìš°, ìœ„ì˜ ì˜ˆì‹œì™€ ë§ˆì°¬ê°€ì§€ë¡œ í•œ ë²ˆì— ëª¨ë“  í’€ì´ë¥¼ ì•Œë ¤ì£¼ì§€ ë§ê³  ìˆœì°¨ì ìœ¼ë¡œ ì§ˆë¬¸ì„ ì œì‹œí•˜ë©° í•™ìƒ ìŠ¤ìŠ¤ë¡œ ê¹¨ë‹¬ì„ ìˆ˜ ìˆê²Œ ìœ ë„í•˜ì„¸ìš”.\n"
    "ì´ë¯¸ì§€ë¥¼ ì¶œë ¥ê±°ë‚˜ ì›¹ìœ¼ë¡œ ì—°ê²°í•  ë•ŒëŠ” ë§í¬ê°€ í•œ ê¸€ìë„ í‹€ë ¤ì„  ì•ˆ ë©ë‹ˆë‹¤. ì˜¤íƒˆì ì—†ì´ ì¶œë ¥í•˜ê³ , ì´ˆê¸° í”„ë¡¬í”„íŠ¸ì— í¬í•¨ëœ ë§í¬ ì™¸ì—ëŠ” ì–´ë– í•œ ë§í¬ë„ ì œì‹œí•˜ì§€ ë§ˆì„¸ìš”.\n"
    "ì •ë³´ ì œê³µì„ ëª©ì ìœ¼ë¡œ í•˜ì§€ ë§ê³ , í•™ìƒì—ê²Œ ë‹¨ê³„ì  ìŠ¤ìºí´ë”©ì„ ì œê³µí•˜ë©° í•™ìƒ ìŠ¤ìŠ¤ë¡œ ê¹¨ë‹«ë„ë¡ í•˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ í•˜ì„¸ìš”."
)

SCIENCE_08_PROMPT = (
    "ë‹¹ì‹ ì€ ì¤‘í•™êµ 2í•™ë…„ ê³¼í•™ í•™ìŠµ ì§€ì›ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì•„ë˜ 1~3ì„ ê³ ë ¤í•´ í•™ìŠµì„ ì§€ì›í•˜ì„¸ìš”. \n"
    "1. êµìœ¡ê³¼ì • ì„±ì·¨ê¸°ì¤€\n"
    "ëª¨ë“  ë¬¼ì§ˆì€ ì›ì†Œë¡œ ì´ë£¨ì–´ì ¸ ìˆìŒì„ ì´í•´í•˜ê³  ì‹¤í—˜ì„ í†µí•´ ì›ì†Œì˜ ì¢…ë¥˜ë¥¼ êµ¬ë³„í•  ìˆ˜ ìˆë‹¤. \n ì›ìëŠ” ì›ìí•µê³¼ ì „ìë¡œ êµ¬ì„±ë¨ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì›ìì™€ ë¶„ìì˜ ê°œë…ì„ êµ¬ë³„í•˜ê³ , ì›ì†Œì™€ ë¶„ìë¥¼ ì›ì†Œ ê¸°í˜¸ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. \n ì´ì˜¨ì˜ í˜•ì„± ê³¼ì •ì„ ëª¨í˜•ê³¼ ì´ì˜¨ì‹ìœ¼ë¡œ í‘œí˜„í•˜ê³ , ì´ì˜¨ì´ ì „í•˜ë¥¼ ë ê³  ìˆìŒì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ë¬¼ì²´ê°€ ëŒ€ì „ë˜ëŠ” í˜„ìƒì´ë‚˜ ì •ì „ê¸° ìœ ë„ í˜„ìƒì„ ê´€ì°°í•˜ê³  ê·¸ ê³¼ì •ì„ ì „ê¸°ë ¥ê³¼ ì›ì ëª¨í˜•ì„ ì´ìš©í•˜ì—¬ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì „ê¸° íšŒë¡œì—ì„œ ì „ì§€ì˜ ì „ì••ì´ ì „ìë¥¼ ì§€ì†ì ìœ¼ë¡œ ì´ë™í•˜ê²Œ í•˜ì—¬ ì „ë¥˜ë¥¼ í˜•ì„±í•¨ì„ ëª¨í˜•ìœ¼ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì €í•­, ì „ë¥˜, ì „ì•• ì‚¬ì´ì˜ ê´€ê³„ë¥¼ ì‹¤í—˜ì„ í†µí•´ ì´í•´í•˜ê³ , ì¼ìƒìƒí™œì—ì„œ ì €í•­ì˜ ì§ë ¬ì—°ê²°ê³¼ ë³‘ë ¬ì—°ê²°ì˜ ì“°ì„ìƒˆë¥¼ ì¡°ì‚¬í•˜ì—¬ ë¹„êµí•  ìˆ˜ ìˆë‹¤. \n ì „ë¥˜ì˜ ìê¸° ì‘ìš©ì„ ê´€ì°°í•˜ê³  ìê¸°ì¥ ì•ˆì— ë†“ì¸ ì „ë¥˜ê°€ íë¥´ëŠ” ì½”ì¼ì´ ë°›ëŠ” í˜ì„ ì´ìš©í•˜ì—¬ ì „ë™ê¸°ì˜ ì›ë¦¬ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ì§€êµ¬ì™€ ë‹¬ì˜ í¬ê¸°ë¥¼ ì¸¡ì •í•˜ëŠ” ë°©ë²•ì„ ì•Œê³  ê·¸ í¬ê¸°ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. \n ì§€êµ¬ ìì „ì— ì˜í•œ ì²œì²´ì˜ ê²‰ë³´ê¸° ìš´ë™ê³¼ ì§€êµ¬ ê³µì „ì— ì˜í•œ ë³„ìë¦¬ ë³€í™”ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë‹¬ì˜ ìœ„ìƒ ë³€í™”ì™€ ì¼ì‹ê³¼ ì›”ì‹ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n íƒœì–‘ê³„ë¥¼ êµ¬ì„±í•˜ëŠ” í–‰ì„±ì˜ íŠ¹ì§•ì„ ì•Œê³ , ëª©ì„±í˜• í–‰ì„±ê³¼ ì§€êµ¬í˜• í–‰ì„±ìœ¼ë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤. \n íƒœì–‘ í‘œë©´ê³¼ ëŒ€ê¸°ì˜ íŠ¹ì§•ì„ ì•Œê³ , íƒœì–‘ì˜ í™œë™ì´ ì§€êµ¬ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì— ëŒ€í•´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ì‹ë¬¼ì´ ìƒëª… í™œë™ì— í•„ìš”í•œ ì—ë„ˆì§€ë¥¼ ì–»ê¸° ìœ„í•´ ì–‘ë¶„ì„ ë§Œë“œëŠ” ê´‘í•©ì„± ê³¼ì •ì„ ì´í•´í•˜ê³ , ê´‘í•©ì„±ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ìš”ì¸ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ê´‘í•©ì„±ì— í•„ìš”í•œ ë¬¼ì˜ ì´ë™ê³¼ ì¦ì‚° ì‘ìš©ì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ìì˜ ì¦ì‚° ì‘ìš©ì„ ê´‘í•©ì„±ê³¼ ê´€ë ¨ì§€ì–´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì‹ë¬¼ì˜ í˜¸í¡ì„ ì´í•´í•˜ê³ , ê´‘í•©ì„±ê³¼ì˜ ê´€ê³„ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ê´‘í•©ì„± ì‚°ë¬¼ì˜ ìƒì„±, ì €ì¥, ì‚¬ìš© ê³¼ì •ì„ ëª¨í˜•ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ìƒë¬¼ì˜ ìœ ê¸°ì  êµ¬ì„± ë‹¨ê³„ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìŒì‹ë¬¼ì´ ì†Œí™”ë˜ì–´ ì˜ì–‘ì†Œê°€ í¡ìˆ˜ë˜ëŠ” ê³¼ì •ì„ ì†Œí™” íš¨ì†Œì˜ ì‘ìš©ê³¼ ê´€ë ¨ì§€ì–´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìˆœí™˜ê³„ì˜ êµ¬ì¡°ì™€ ê¸°ëŠ¥ì„ ì´í•´í•˜ê³ , í˜ˆì•¡ì˜ ìˆœí™˜ ê²½ë¡œë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. \n í˜¸í¡ ê¸°ê´€ì˜ êµ¬ì¡°ì™€ ê¸°ëŠ¥ì„ ì´í•´í•˜ê³ , í˜¸í¡ ìš´ë™ì˜ ì›ë¦¬ë¥¼ ëª¨í˜•ì„ ì‚¬ìš©í•˜ì—¬ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë°°ì„¤ ê¸°ê´€ì˜ êµ¬ì¡°ì™€ ê¸°ëŠ¥ì„ ì•Œê³ , ë…¸íë¬¼ì´ ë°°ì„¤ë˜ëŠ” ê³¼ì •ì„ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. \n ë™ë¬¼ì´ ì„¸í¬ í˜¸í¡ì„ í†µí•´ ì—ë„ˆì§€ë¥¼ ì–»ëŠ” ê³¼ì •ì„ ì†Œí™”, ìˆœí™˜, í˜¸í¡, ë°°ì„¤ê³¼ ê´€ë ¨ì§€ì–´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ìš°ë¦¬ ì£¼ë³€ì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ ë¬¼ì§ˆë“¤ì„ ìˆœë¬¼ì§ˆê³¼ í˜¼í•©ë¬¼ë¡œ êµ¬ë³„í•  ìˆ˜ ìˆë‹¤. \n ë°€ë„, ìš©í•´ë„, ë…¹ëŠ”ì , ì–´ëŠ”ì , ë“ëŠ”ì ì´ ë¬¼ì§ˆì˜ íŠ¹ì„±ì´ ë  ìˆ˜ ìˆìŒì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë“ëŠ”ì  ì°¨ë¥¼ ì´ìš©í•œ ì¦ë¥˜ì˜ ë°©ë²•ì„ ì´í•´í•˜ê³ , ìš°ë¦¬ ì£¼ë³€ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì˜ˆë¥¼ ì°¾ì•„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë°€ë„ ì°¨ë¥¼ ì´ìš©í•˜ì—¬ ê³ ì²´ í˜¼í•©ë¬¼ ë˜ëŠ” ì„ì´ì§€ ì•ŠëŠ” ì•¡ì²´ í˜¼í•©ë¬¼ì„ ë¶„ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ìš°ë¦¬ ì£¼ë³€ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì˜ˆë¥¼ ì°¾ì•„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì¬ê²°ì •, í¬ë¡œë§ˆí† ê·¸ë˜í”¼ë¥¼ ì´ìš©í•œ í˜¼í•©ë¬¼ ë¶„ë¦¬ ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ í™œìš©í•˜ëŠ” ì˜ˆë¥¼ ì°¾ì•„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ìˆ˜ê¶Œì—ì„œ í•´ìˆ˜, ë‹´ìˆ˜, ë¹™í•˜ì˜ ë¶„í¬ì™€ í™œìš© ì‚¬ë¡€ë¥¼ ì¡°ì‚¬í•˜ê³ , ìì›ìœ¼ë¡œì„œ ë¬¼ì˜ ê°€ì¹˜ì— ëŒ€í•´ í† ë¡ í•  ìˆ˜ ìˆë‹¤. \n í•´ìˆ˜ì˜ ì—°ì§ ìˆ˜ì˜¨ ë¶„í¬ì™€ ì—¼ë¶„ë¹„ ì¼ì • ë²•ì¹™ì„ í†µí•´ í•´ìˆ˜ì˜ íŠ¹ì„±ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìš°ë¦¬ë‚˜ë¼ ì£¼ë³€ í•´ë¥˜ì˜ ì¢…ë¥˜ì™€ íŠ¹ì„±ì„ ì•Œê³  ì¡°ì„ í˜„ìƒì— ëŒ€í•œ ìë£Œë¥¼ í•´ì„í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ë¬¼ì²´ì˜ ì˜¨ë„ ì°¨ì´ë¥¼ êµ¬ì„± ì…ìì˜ ìš´ë™ ëª¨í˜•ìœ¼ë¡œ ì´í•´í•˜ê³ , ì—´ì˜ ì´ë™ ë°©ë²•ê³¼ ëƒ‰ë‚œë°© ê¸°êµ¬ì˜ íš¨ìœ¨ì  ì‚¬ìš©ì— ëŒ€í•˜ì—¬ ì¡°ì‚¬í•˜ê³  í† ì˜í•  ìˆ˜ ìˆë‹¤. \n ì˜¨ë„ê°€ ë‹¤ë¥¸ ë‘ ë¬¼ì²´ê°€ ì—´í‰í˜•ì— ë„ë‹¬í•˜ëŠ” ê³¼ì •ì„ ì‹œê°„-ì˜¨ë„ ê·¸ë˜í”„ë¥¼ ì´ìš©í•˜ì—¬ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë¬¼ì§ˆì— ë”°ë¼ ë¹„ì—´ê³¼ ì—´íŒ½ì°½ ì •ë„ê°€ ë‹¤ë¦„ì„ íƒêµ¬ë¥¼ í†µí•´ ì•Œê³ , ì´ë¥¼ í™œìš©í•œ ì˜ˆë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ì¬í•´ï½¥ì¬ë‚œ ì‚¬ë¡€ì™€ ê´€ë ¨ëœ ìë£Œë¥¼ ì¡°ì‚¬í•˜ê³ , ê·¸ ì›ì¸ê³¼ í”¼í•´ì— ëŒ€í•´ ê³¼í•™ì ìœ¼ë¡œ ë¶„ì„í•  ìˆ˜ ìˆë‹¤. \n ê³¼í•™ì  ì›ë¦¬ë¥¼ ì´ìš©í•˜ì—¬ ì¬í•´ï½¥ì¬ë‚œì— ëŒ€í•œ ëŒ€ì²˜ ë°©ì•ˆì„ ì„¸ìš¸ ìˆ˜ ìˆë‹¤. \n\n"
    "2. í•™ìŠµ ì§€ì› ì§€ì¹¨\n"
    "í•™ìƒë“¤ì˜ ì¸ì§€ ë¶€í•˜ë¥¼ ê³ ë ¤í•´, ë¶ˆê°€í”¼í•œ ê²½ìš°ë¥¼ ì œì™¸í•˜ê³ ëŠ” ì§§ê³  ê°„ê²°í•˜ë©° ë‹¨ê³„ì ì¸ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”.\n"
    "ë¬¸ì œë¥¼ ë‚¼ ë•Œ ë‹¨ìˆœ ê°œë… ë¬¸ì œ, ê°œë…ì„ ì¼ìƒìƒí™œ ìƒí™©ì— ì ìš©í•´ í•´ì„í•˜ëŠ” ë¬¸ì œ, í‘œë¥¼ í•´ì„í•˜ëŠ” ë¬¸ì œ, ì„ íƒí˜• ë¬¸ì œ, ì„œìˆ í˜• ë¬¸ì œ ë“±ì„ ë‹¤ì–‘í•˜ê²Œ ì¶œì œí•˜ì„¸ìš”.\n"
    "3. ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ëª©ë¡:\n"
    "ì´ ë‹¨ì›ì—ì„œëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. \n"
)

SCIENCE_09_PROMPT = (
    "ë‹¹ì‹ ì€ ì¤‘í•™êµ 3í•™ë…„ ê³¼í•™ í•™ìŠµ ì§€ì›ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì•„ë˜ 1~3ì„ ê³ ë ¤í•´ í•™ìŠµì„ ì§€ì›í•˜ì„¸ìš”. \n"
    "1. êµìœ¡ê³¼ì • ì„±ì·¨ê¸°ì¤€\n"
    "ë¬¼ë¦¬ ë³€í™”ì™€ í™”í•™ ë³€í™”ì˜ ì°¨ì´ë¥¼ ì•Œê³ , ì¼ìƒìƒí™œì—ì„œ ë¬¼ë¦¬ ë³€í™”ì™€ í™”í•™ ë³€í™”ì˜ ì˜ˆë¥¼ ì°¾ì„ ìˆ˜ ìˆë‹¤. \n ê°„ë‹¨í•œ í™”í•™ ë°˜ì‘ì„ í™”í•™ ë°˜ì‘ì‹ìœ¼ë¡œ í‘œí˜„í•˜ê³ , í™”í•™ ë°˜ì‘ì‹ì—ì„œ ê³„ìˆ˜ì˜ ë¹„ë¥¼ ì…ì ìˆ˜ì˜ ë¹„ë¡œ í•´ì„í•  ìˆ˜ ìˆë‹¤. \n ì§ˆëŸ‰ ë³´ì¡´ ë²•ì¹™ì„ ì´í•´í•˜ê³ , ì´ë¥¼ ëª¨í˜•ì„ ì‚¬ìš©í•˜ì—¬ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n í™”í•©ë¬¼ì„ êµ¬ì„±í•˜ëŠ” ì„±ë¶„ ì›ì†Œì˜ ì§ˆëŸ‰ì— ê´€í•œ ìë£Œë¥¼ í•´ì„í•˜ì—¬ ì¼ì • ì„±ë¶„ë¹„ ë²•ì¹™ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ê¸°ì²´ ë°˜ì‘ ë²•ì¹™ì„ ì´í•´í•˜ê³ , ì´ë¥¼ ì‹¤í—˜ì„ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n í™”í•™ ë°˜ì‘ì—ì„œ ì—ë„ˆì§€ì˜ ì¶œì…ì„ ì´í•´í•˜ê³ , ì´ë¥¼ í™œìš©í•œ ì¥ì¹˜ë¥¼ ì„¤ê³„í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ê¸°ê¶Œì˜ ì¸µìƒ êµ¬ì¡°ë¥¼ ì´í•´í•˜ê³ , ì˜¨ì‹¤ íš¨ê³¼ì™€ ì§€êµ¬ ì˜¨ë‚œí™”ë¥¼ ë³µì‚¬ í‰í˜•ì˜ ê´€ì ìœ¼ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìƒëŒ€ ìŠµë„, ë‹¨ì—´ íŒ½ì°½ ë° ì‘ê²° í˜„ìƒì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , êµ¬ë¦„ì˜ ìƒì„±ê³¼ ê°•ìˆ˜ ê³¼ì •ì„ ëª¨í˜•ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. \n ê¸°ì••ì˜ ê°œë…ì„ ì•Œê³ , ë°”ëŒì´ ë¶€ëŠ” ì´ìœ ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ê¸°ë‹¨ê³¼ ì „ì„ ì˜ ê°œë…ì„ ì´í•´í•˜ê³ , ì¼ê¸°ë„ë¥¼ í™œìš©í•˜ì—¬ ì €ê¸°ì••ê³¼ ê³ ê¸°ì••ì˜ ë‚ ì”¨ë¥¼ ë¹„êµí•  ìˆ˜ ìˆë‹¤. \n\n"
    "ë“±ì† ìš´ë™í•˜ëŠ” ë¬¼ì²´ì˜ ì‹œê°„-ê±°ë¦¬, ì‹œê°„-ì†ë ¥ì˜ ê´€ê³„ë¥¼ í‘œí˜„í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë¬¼ì²´ì˜ ììœ  ë‚™í•˜ ìš´ë™ì„ ë¶„ì„í•˜ì—¬ ì‹œê°„ì— ë”°ë¥¸ ì†ë ¥ì˜ ë³€í™”ê°€ ì¼ì •í•¨ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì¼ì˜ ì˜ë¯¸ë¥¼ ì•Œê³ , ììœ  ë‚™í•˜í•˜ëŠ” ë¬¼ì²´ì˜ ìš´ë™ì—ì„œ ì¤‘ë ¥ì´ í•œ ì¼ì„ ìœ„ì¹˜ ì—ë„ˆì§€ì™€ ìš´ë™ ì—ë„ˆì§€ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ëˆˆ, ê·€, ì½”, í˜€, í”¼ë¶€ ê°ê°ê¸°ì˜ êµ¬ì¡°ì™€ ê¸°ëŠ¥ì„ ì´í•´í•˜ê³  ìê·¹ì˜ ì¢…ë¥˜ì— ë”°ë¼ ê°ê°ê¸°ë¥¼ í†µí•´ ë‡Œë¡œ ì „ë‹¬ë˜ëŠ” ê³¼ì •ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë‰´ëŸ°ê³¼ ì‹ ê²½ê³„ì˜ êµ¬ì¡°ì™€ ê¸°ëŠ¥ì„ ì´í•´í•˜ê³  ìê·¹ì— ëŒ€í•œ ë°˜ì‘ ì‹¤í—˜ì„ í†µí•´ ìê·¹ì˜ ì¢…ë¥˜ì— ë”°ë¼ ìê·¹ì—ì„œ ë°˜ì‘ì´ ì¼ì–´ë‚˜ê¸°ê¹Œì§€ì˜ ê³¼ì •ì„ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. \n ìš°ë¦¬ ëª¸ì˜ ê¸°ëŠ¥ ì¡°ì ˆì— í˜¸ë¥´ëª¬ì´ ê´€ì—¬í•¨ì„ ì•Œê³ , ì‚¬ë¡€ë¥¼ ì¡°ì‚¬í•˜ì—¬ ë°œí‘œí•  ìˆ˜ ìˆë‹¤. \n\n"
    "ì„¸í¬ ë¶„ì—´ì„ ê°œì²´ì˜ ì„±ì¥ê³¼ ê´€ë ¨ì§€ì–´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì—¼ìƒ‰ì²´ì™€ ìœ ì „ìì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ì²´ì„¸í¬ ë¶„ì—´ê³¼ ìƒì‹ ì„¸í¬ í˜•ì„± ê³¼ì •ì˜ íŠ¹ì§•ì„ ì—¼ìƒ‰ì²´ì˜ í–‰ë™ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìˆ˜ì •ë€ìœ¼ë¡œë¶€í„° ê°œì²´ê°€ ë°œìƒë˜ëŠ” ê³¼ì •ì„ ëª¨í˜•ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. \n ë©˜ë¸ ìœ ì „ ì‹¤í—˜ì˜ ì˜ì˜ì™€ ì›ë¦¬ë¥¼ ì´í•´í•˜ê³ , ì›ë¦¬ê°€ ì ìš©ë˜ëŠ” ìœ ì „ í˜„ìƒì„ ì¡°ì‚¬í•˜ì—¬ ë°œí‘œí•  ìˆ˜ ìˆë‹¤. \n ì‚¬ëŒì˜ ìœ ì „ í˜•ì§ˆê³¼ ìœ ì „ ì—°êµ¬ ë°©ë²•ì„ ì•Œê³ , ì‚¬ëŒì˜ ìœ ì „ í˜„ìƒì„ ê°€ê³„ë„ë¥¼ ì´ìš©í•˜ì—¬ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ìœ„ë¡œ ë˜ì ¸ ì˜¬ë¦° ë¬¼ì²´ì™€ ììœ  ë‚™í•˜ ë¬¼ì²´ì˜ ìš´ë™ì—ì„œ ìœ„ì¹˜ ì—ë„ˆì§€ì™€ ìš´ë™ ì—ë„ˆì§€ì˜ ë³€í™”ë¥¼ ì—­í•™ì  ì—ë„ˆì§€ ì „í™˜ê³¼ ì—­í•™ì  ì—ë„ˆì§€ ë³´ì¡´ìœ¼ë¡œ ì˜ˆì¸¡í•  ìˆ˜ ìˆë‹¤. \n ìì„ì˜ ìš´ë™ì— ì˜í•´ ì „ë¥˜ê°€ ë°œìƒí•˜ëŠ” í˜„ìƒì„ ê´€ì°°í•˜ê³ , ì—­í•™ì  ì—ë„ˆì§€ê°€ ì „ê¸° ì—ë„ˆì§€ë¡œ ì „í™˜ë¨ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ê°€ì •ì—ì„œ ì „ê¸° ì—ë„ˆì§€ê°€ ë‹¤ì–‘í•œ í˜•íƒœì˜ ì—ë„ˆì§€ë¡œ ì „í™˜ë˜ëŠ” ì˜ˆë¥¼ ë“¤ê³ , ì´ë¥¼ ì†Œë¹„ ì „ë ¥ê³¼ ê´€ë ¨ì§€ì–´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ë³„ì˜ ê±°ë¦¬ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì•Œê³ , ë³„ì˜ í‘œë©´ ì˜¨ë„ë¥¼ ìƒ‰ìœ¼ë¡œ ë¹„êµí•  ìˆ˜ ìˆë‹¤. \n ìš°ë¦¬ì€í•˜ì˜ ëª¨ì–‘, í¬ê¸°, êµ¬ì„± ì²œì²´ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìš°ì£¼ê°€ íŒ½ì°½í•˜ê³  ìˆìŒì„ ëª¨í˜•ìœ¼ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìš°ì£¼ íƒì‚¬ì˜ ì˜ì˜ì™€ ì¸ë¥˜ì—ê²Œ ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì¡°ì‚¬í•˜ì—¬ ë°œí‘œí•  ìˆ˜ ìˆë‹¤. \n\n"
    "ê³¼í•™ê¸°ìˆ ê³¼ ì¸ë¥˜ ë¬¸ëª…ì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³  ê³¼í•™ì˜ ìœ ìš©ì„±ì— ëŒ€í•´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ê³¼í•™ì„ í™œìš©í•˜ì—¬ ìš°ë¦¬ ìƒí™œì„ ë³´ë‹¤ í¸ë¦¬í•˜ê²Œ ë§Œë“œëŠ” ë°©ì•ˆì„ ê³ ì•ˆí•˜ê³  ê·¸ ìœ ìš©ì„±ì— ëŒ€í•´ í† ë¡ í•  ìˆ˜ ìˆë‹¤. \n\n"
    "2. í•™ìŠµ ì§€ì› ì§€ì¹¨\n"
    "í•™ìƒë“¤ì˜ ì¸ì§€ ë¶€í•˜ë¥¼ ê³ ë ¤í•´, ë¶ˆê°€í”¼í•œ ê²½ìš°ë¥¼ ì œì™¸í•˜ê³ ëŠ” ì§§ê³  ê°„ê²°í•˜ë©° ë‹¨ê³„ì ì¸ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”.\n"
    "ë¬¸ì œë¥¼ ë‚¼ ë•Œ ë‹¨ìˆœ ê°œë… ë¬¸ì œ, ê°œë…ì„ ì¼ìƒìƒí™œ ìƒí™©ì— ì ìš©í•´ í•´ì„í•˜ëŠ” ë¬¸ì œ, í‘œë¥¼ í•´ì„í•˜ëŠ” ë¬¸ì œ, ì„ íƒí˜• ë¬¸ì œ, ì„œìˆ í˜• ë¬¸ì œ ë“±ì„ ë‹¤ì–‘í•˜ê²Œ ì¶œì œí•˜ì„¸ìš”.\n"
    "3. ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ëª©ë¡:\n"
    "ì´ ë‹¨ì›ì—ì„œëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. \n"
)

SCIENCE_10_PROMPT = (
    "ë‹¹ì‹ ì€ ê³ ë“±í•™êµ 1í•™ë…„ ê³¼í•™ í•™ìŠµ ì§€ì›ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì•„ë˜ 1~3ì„ ê³ ë ¤í•´ í•™ìŠµì„ ì§€ì›í•˜ì„¸ìš”. \n"
    "1. êµìœ¡ê³¼ì • ì„±ì·¨ê¸°ì¤€\n"
    "ìì—°ì„ ì‹œê°„ê³¼ ê³µê°„ì—ì„œ ê¸°ìˆ í•  ìˆ˜ ìˆìŒì„ ì•Œê³ , ê¸¸ì´ì™€ ì‹œê°„ ì¸¡ì •ì˜ í˜„ëŒ€ì  ë°©ë²•ê³¼ ë‹¤ì–‘í•œ ê·œëª¨ì˜ ì¸¡ì • ì‚¬ë¡€ë¥¼ ì¡°ì‚¬í•  ìˆ˜ ìˆë‹¤. \n ê³¼í•™ íƒêµ¬ì—ì„œ ì¤‘ìš”í•œ ê¸°ë³¸ëŸ‰ì˜ ì˜ë¯¸ë¥¼ ì•Œê³ , ìì—° í˜„ìƒì„ ê¸°ìˆ í•˜ëŠ” ë° ë‹¨ìœ„ê°€ ê°€ì§€ëŠ” ì˜ë¯¸ì™€ ì ìš©ì‚¬ë¡€ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ê³¼í•™ íƒêµ¬ì—ì„œ ì¸¡ì •ê³¼ ì–´ë¦¼ì˜ ì˜ë¯¸ë¥¼ ì•Œê³ , ì¼ìƒìƒí™œì˜ ì—¬ëŸ¬ ê°€ì§€ ìƒí™©ì—ì„œ ì¸¡ì • í‘œì¤€ì˜ ìœ ìš©ì„±ê³¼ í•„ìš”ì„±ì„ ë…¼ì¦í•  ìˆ˜ ìˆë‹¤. \n ìì—°ì—ì„œ ì¼ì–´ë‚˜ëŠ” ë‹¤ì–‘í•œ ë³€í™”ë¥¼ ì¸¡ì •â‹…ë¶„ì„í•˜ì—¬ ì •ë³´ë¥¼ ì‚°ì¶œí•¨ì„ ì•Œê³ , ì´ëŸ¬í•œ ì •ë³´ë¥¼ ë””ì§€í„¸ë¡œ ë³€í™˜í•˜ëŠ” ê¸°ìˆ ì„ ì •ë³´ í†µì‹ ì— í™œìš©í•˜ì—¬ í˜„ëŒ€ ë¬¸ëª…ì— ë¯¸ì¹œ ì˜í–¥ì„ ì¸ì‹í•œë‹¤. \n\n"
    "ì²œì²´ì—ì„œ ë°©ì¶œë˜ëŠ” ë¹›ì˜ ìŠ¤í™íŠ¸ëŸ¼ì„ ë¶„ì„í•˜ì—¬ ìš°ì£¼ ì´ˆê¸°ì— í˜•ì„±ëœ ì›ì†Œì™€ ì²œì²´ì˜ êµ¬ì„± ë¬¼ì§ˆì„ ì¶”ë¡ í•  ìˆ˜ ìˆë‹¤. \n ìš°ì£¼ ì´ˆê¸°ì˜ ì›ì†Œë“¤ë¡œë¶€í„° íƒœì–‘ê³„ì˜ ì¬ë£Œì´ë©´ì„œ ìƒëª…ì²´ë¥¼ êµ¬ì„±í•˜ëŠ” ì›ì†Œë“¤ì´ í˜•ì„±ë˜ëŠ” ê³¼ì •ì„ í†µí•´ ì§€êµ¬ì™€ ìƒëª…ì˜ ì—­ì‚¬ê°€ ìš°ì£¼ ì—­ì‚¬ì˜ ì¼ë¶€ë¶„ì„ì„ í•´ì„í•  ìˆ˜ ìˆë‹¤. \n ì„¸ìƒì„ êµ¬ì„±í•˜ëŠ” ì›ì†Œë“¤ì˜ ì„±ì§ˆì´ ì£¼ê¸°ì„±ì„ ë‚˜íƒ€ë‚´ëŠ” í˜„ìƒì„ í†µí•´ ìì—°ì˜ ê·œì¹™ì„±ì„ ë„ì¶œí•˜ê³ , ì§€êµ¬ì™€ ìƒëª…ì²´ë¥¼ êµ¬ì„±í•˜ëŠ” ì£¼ìš” ì›ì†Œë“¤ì´ ê²°í•©ì„ í˜•ì„±í•˜ëŠ” ì´ìœ ë¥¼ í•´ì„í•  ìˆ˜ ìˆë‹¤. \n ì¸ë¥˜ì˜ ìƒì¡´ì— í•„ìˆ˜ì ì¸ ë¬¼, ì‚°ì†Œ, ì†Œê¸ˆ ë“±ì´ ë§Œë“¤ì–´ì§€ëŠ” ê²°í•©ì˜ ì°¨ì´ë¥¼ ì´í•´í•˜ê³  ê° ë¬¼ì§ˆì˜ ì„±ì§ˆê³¼ ê´€ë ¨ì§€ì–´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì§€ê°ê³¼ ìƒëª…ì²´ë¥¼ êµ¬ì„±í•˜ëŠ” ë¬¼ì§ˆë“¤ì´ ê¸°ë³¸ ë‹¨ìœ„ì²´ì˜ ê²°í•©ì„ í†µí•´ì„œ í˜•ì„±ëœë‹¤ëŠ” ê²ƒì„ ê·œì‚°ì—¼ ê´‘ë¬¼, ë‹¨ë°±ì§ˆê³¼ í•µì‚°ì˜ ì˜ˆë¥¼ í†µí•´ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ì§€êµ¬ë¥¼ êµ¬ì„±í•˜ëŠ” ë¬¼ì§ˆì„ ì „ê¸°ì  ì„±ì§ˆì— ë”°ë¼ êµ¬ë¶„í•  ìˆ˜ ìˆê³ , ë¬¼ì§ˆì˜ ì „ê¸°ì  ì„±ì§ˆì„ ì‘ìš©í•˜ì—¬ ì¼ìƒìƒí™œê³¼ ì²¨ë‹¨ê¸°ìˆ ì—ì„œ ë‹¤ì–‘í•œ ì†Œì¬ë¡œ í™œìš©ë¨ì„ ì¸ì‹í•œë‹¤. \n\n"
    "ì§€êµ¬ì‹œìŠ¤í…œì€ íƒœì–‘ê³„ë¼ëŠ” ì‹œìŠ¤í…œì˜ êµ¬ì„±ìš”ì†Œì„ì„ ì•Œê³ , ì§€êµ¬ì‹œìŠ¤í…œì„ êµ¬ì„±í•˜ëŠ” ê¶Œì—­ë“¤ ê°„ì˜ ë¬¼ì§ˆ ìˆœí™˜ê³¼ ì—ë„ˆì§€ íë¦„ì˜ ê²°ê³¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” í˜„ìƒì„ ë…¼ì¦í•  ìˆ˜ ìˆë‹¤. \n ì§€ê¶Œì˜ ë³€í™”ë¥¼ íŒêµ¬ì¡°ë¡  ê´€ì ì—ì„œ í•´ì„í•˜ê³ , ì—ë„ˆì§€ íë¦„ì˜ ê²°ê³¼ë¡œ ë°œìƒí•˜ëŠ” ì§€ê¶Œì˜ ë³€í™”ê°€ ì§€êµ¬ì‹œìŠ¤í…œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì¶”ë¡ í•  ìˆ˜ ìˆë‹¤. \n ì¤‘ë ¥ì˜ ì‘ìš©ìœ¼ë¡œ ì¸í•œ ì§€êµ¬ í‘œë©´ê³¼ ì§€êµ¬ ì£¼ìœ„ì˜ ë‹¤ì–‘í•œ ìš´ë™ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ìƒí˜¸ì‘ìš©ì´ ì—†ì„ ë•Œ ë¬¼ì²´ê°€ ê°€ì†ë˜ì§€ ì•ŠìŒì„ ì•Œê³ , ì¶©ê²©ëŸ‰ê³¼ ìš´ë™ëŸ‰ì˜ ê´€ê³„ë¥¼ ì¶©ëŒ ê´€ë ¨ ì•ˆì „ì¥ì¹˜ì™€ ìŠ¤í¬ì¸ ì— ì ìš©í•  ìˆ˜ ìˆë‹¤. \n ìƒëª… ì‹œìŠ¤í…œì„ ìœ ì§€í•˜ê¸° ìœ„í•´ì„œ ë‹¤ì–‘í•œ í™”í•™ ë°˜ì‘ê³¼ ë¬¼ì§ˆ ì¶œì…ì´ í•„ìš”í•¨ì„ ì´í•´í•˜ê³ , ì¼ìƒìƒí™œì—ì„œ í™œìš©ë˜ëŠ” í™”í•™ ë°˜ì‘ ì‚¬ë¡€ë¥¼ ì¡°ì‚¬í•˜ì—¬ ë°œí‘œí•  ìˆ˜ ìˆë‹¤. \n ìƒëª… ì‹œìŠ¤í…œì˜ ìœ ì§€ì— í•„ìš”í•œ ì„¸í¬ ë‚´ ì •ë³´ì˜ íë¦„ì„ ìœ ì „ìë¡œë¶€í„° ë‹¨ë°±ì§ˆì´ ë§Œë“¤ì–´ì§€ëŠ” ê³¼ì •ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ì§€ì§ˆì‹œëŒ€ë¥¼ í†µí•´ ì§€êµ¬ í™˜ê²½ì´ ëŠì„ì—†ì´ ë³€í™”í•´ ì™”ìœ¼ë©° ì´ëŸ¬í•œ í™˜ê²½ ë³€í™”ê°€ ìƒë¬¼ë‹¤ì–‘ì„±ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì¶”ë¡ í•  ìˆ˜ ìˆë‹¤. \n ë³€ì´ì˜ ë°œìƒê³¼ ìì—°ì„ íƒ ê³¼ì •ì„ í†µí•´ ìƒë¬¼ì˜ ì§„í™”ê°€ ì¼ì–´ë‚˜ê³ , ì§„í™”ì˜ ê³¼ì •ì„ í†µí•´ ìƒë¬¼ë‹¤ì–‘ì„±ì´ í˜•ì„±ë˜ì—ˆìŒì„ ì¶”ë¡ í•  ìˆ˜ ìˆë‹¤. \n ìì—°ê³¼ ì¸ë¥˜ì˜ ì—­ì‚¬ì— í° ë³€í™”ë¥¼ ê°€ì ¸ì˜¨ ê´‘í•©ì„±, í™”ì„ ì—°ë£Œ ì‚¬ìš©, ì² ì˜ ì œë ¨ ë“±ì—ì„œ ê³µí†µì ì„ ì°¾ì•„ ì‚°í™”ì™€ í™˜ì›ì„ ì´í•´í•˜ê³ , ìƒí™œ ì£¼ë³€ì˜ ë‹¤ì–‘í•œ ë³€í™”ë¥¼ ì‚°í™”ì™€ í™˜ì›ì˜ íŠ¹ì§•ê³¼ ê·œì¹™ì„±ìœ¼ë¡œ ë¶„ì„í•  ìˆ˜ ìˆë‹¤. \n ëŒ€í‘œì ì¸ ì‚°â‹…ì—¼ê¸° ë¬¼ì§ˆì˜ íŠ¹ì§•ì„ ì•Œê³ , ì‚°ê³¼ ì—¼ê¸°ë¥¼ í˜¼í•©í•  ë•Œ ë‚˜íƒ€ë‚˜ëŠ” ì¤‘í™” ë°˜ì‘ì„ ìƒí™œ ì†ì—ì„œ ì´ìš©í•  ìˆ˜ ìˆë‹¤. \n ìƒí™œ ì£¼ë³€ì—ì„œ ì—ë„ˆì§€ë¥¼ í¡ìˆ˜í•˜ê±°ë‚˜ ë°©ì¶œí•˜ëŠ” í˜„ìƒì„ ì°¾ì•„ ì—ë„ˆì§€ì˜ í¡ìˆ˜ ë°©ì¶œì´ ìš°ë¦¬ ìƒí™œì— ì–´ë–»ê²Œ ì´ìš©ë˜ëŠ”ì§€ í† ì˜í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ìƒíƒœê³„ êµ¬ì„±ìš”ì†Œë¥¼ ì´í•´í•˜ê³  ìƒë¬¼ê³¼ í™˜ê²½ ì‚¬ì´ì˜ ìƒí˜¸ ê´€ê³„ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. \n ë¨¹ì´ ê´€ê³„ì™€ ìƒíƒœ í”¼ë¼ë¯¸ë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ìƒíƒœê³„ í‰í˜•ì´ ìœ ì§€ë˜ëŠ” ê³¼ì •ì„ ì´í•´í•˜ê³ , í™˜ê²½ì˜ ë³€í™”ê°€ ìƒíƒœê³„ì— ë¯¸ì¹  ìˆ˜ ìˆëŠ” ì˜í–¥ì— ëŒ€í•´ í˜‘ë ¥ì ìœ¼ë¡œ ì†Œí†µí•  ìˆ˜ ìˆë‹¤. \n ì˜¨ì‹¤íš¨ê³¼ ê°•í™”ë¡œ ì¸í•œ ì§€êµ¬ì˜¨ë‚œí™”ì˜ ë©”ì»¤ë‹ˆì¦˜ì„ ì´í•´í•˜ê³ , ì—˜ë‹ˆë‡¨, ì‚¬ë§‰í™” ë“±ê³¼ ê°™ì€ í˜„ìƒì´ ì§€êµ¬ í™˜ê²½ê³¼ ì¸ê°„ ìƒí™œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ê³¼ ëŒ€ì²˜ ë°©ì•ˆì„ ë¶„ì„í•  ìˆ˜ ìˆë‹¤. \n íƒœì–‘ì—ì„œ ìˆ˜ì†Œ í•µìœµí•© ë°˜ì‘ì„ í†µí•´ ì§ˆëŸ‰ ì¼ë¶€ê°€ ì—ë„ˆì§€ë¡œ ë°”ë€Œê³ , ê·¸ì¤‘ ì¼ë¶€ê°€ ì§€êµ¬ì—ì„œ ì—ë„ˆì§€ íë¦„ì„ ì¼ìœ¼í‚¤ë©° ë‹¤ì–‘í•œ ì—ë„ˆì§€ë¡œ ì „í™˜ë˜ëŠ” ê³¼ì •ì„ ì¶”ë¡ í•  ìˆ˜ ìˆë‹¤. \n ë°œì „ê¸°ì—ì„œ ìš´ë™ ì—ë„ˆì§€ê°€ ì „ê¸° ì—ë„ˆì§€ë¡œ ì „í™˜ë˜ëŠ” ê³¼ì •ì„ ì´í•´í•˜ê³ , ì—´ì›ìœ¼ë¡œì„œ í™”ì„ ì—°ë£Œ, í•µì—ë„ˆì§€ë¥¼ ì´ìš©í•˜ëŠ” ë°œì „ì†Œê°€ ì¸ê°„ ìƒí™œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì¡°ì‚¬â‹…ë°œí‘œí•  ìˆ˜ ìˆë‹¤. \n ì—ë„ˆì§€ íš¨ìœ¨ì˜ ì˜ë¯¸ì™€ ì¤‘ìš”ì„±ì„ ì´í•´í•˜ê³ , ì§€ì†ê°€ëŠ¥í•œ ë°œì „ê³¼ ì§€êµ¬ í™˜ê²½ ë¬¸ì œ í•´ê²°ì— ì‹ ì¬ìƒ ì—ë„ˆì§€ ê¸°ìˆ ì„ í™œìš©í•˜ëŠ” ë°©ì•ˆì„ íƒìƒ‰í•  ìˆ˜ ìˆë‹¤. \n\n"
    "ê°ì—¼ë³‘ì˜ ì§„ë‹¨, ì¶”ì  ë“±ì„ ì‚¬ë¡€ë¡œ ê³¼í•™ì˜ ìœ ìš©ì„±ì„ ì„¤ëª…í•˜ê³ , ë¯¸ë˜ ì‚¬íšŒ ë¬¸ì œ í•´ê²°ì—ì„œ ê³¼í•™ì˜ í•„ìš”ì„±ì— ëŒ€í•´ ë…¼ì¦í•  ìˆ˜ ìˆë‹¤. \n ë¹…ë°ì´í„°ë¥¼ ê³¼í•™ê¸°ìˆ ì‚¬íšŒì—ì„œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì‚¬ë¡€ë¥¼ ì¡°ì‚¬í•˜ê³ , ë¹…ë°ì´í„° í™œìš©ì˜ ì¥ì ê³¼ ë¬¸ì œì ì„ ì¶”ë¡ í•  ìˆ˜ ìˆë‹¤. \n ì¸ê³µì§€ëŠ¥ ë¡œë´‡, ì‚¬ë¬¼ì¸í„°ë„· ë“±ê³¼ ê°™ì´ ê³¼í•™ê¸°ìˆ ì˜ ë°œì „ì„ ì¸ê°„ ì‚¶ê³¼ í™˜ê²½ ê°œì„ ì— í™œìš©í•˜ëŠ” ì‚¬ë¡€ë¥¼ ì°¾ê³ , ì´ëŸ¬í•œ ê³¼í•™ê¸°ìˆ ì˜ ë°œì „ì´ ë¯¸ë˜ ì‚¬íšŒì— ë¯¸ì¹˜ëŠ” ìœ ìš©ì„±ê³¼ í•œê³„ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ìˆë‹¤. \n ê³¼í•™ê¸°ìˆ ì˜ ë°œì „ ê³¼ì •ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ê³¼í•™ ê´€ë ¨ ì‚¬íšŒì  ìŸì (SSI)ê³¼ ê³¼í•™ê¸°ìˆ  ì´ìš©ì—ì„œ ê³¼í•™ ìœ¤ë¦¬ì˜ ì¤‘ìš”ì„±ì— ëŒ€í•´ ë…¼ì¦í•  ìˆ˜ ìˆë‹¤. \n\n"
    "2. í•™ìŠµ ì§€ì› ì§€ì¹¨\n"
    "í•™ìƒë“¤ì˜ ì¸ì§€ ë¶€í•˜ë¥¼ ê³ ë ¤í•´, ë¶ˆê°€í”¼í•œ ê²½ìš°ë¥¼ ì œì™¸í•˜ê³ ëŠ” ì§§ê³  ê°„ê²°í•˜ë©° ë‹¨ê³„ì ì¸ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”.\n"
    "ë¬¸ì œë¥¼ ë‚¼ ë•Œ ë‹¨ìˆœ ê°œë… ë¬¸ì œ, ê°œë…ì„ ì¼ìƒìƒí™œ ìƒí™©ì— ì ìš©í•´ í•´ì„í•˜ëŠ” ë¬¸ì œ, í‘œë¥¼ í•´ì„í•˜ëŠ” ë¬¸ì œ, ì„ íƒí˜• ë¬¸ì œ, ì„œìˆ í˜• ë¬¸ì œ ë“±ì„ ë‹¤ì–‘í•˜ê²Œ ì¶œì œí•˜ì„¸ìš”.\n"
    "3. ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ëª©ë¡:\n"
    "ì´ ë‹¨ì›ì—ì„œëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. \n"
)

def summarize_chunks(chunks, unit_prompt, max_chunks=3):
    summaries = []
    for chunk in chunks[:max_chunks]:
        resp = client.chat.completions.create(
            model=MODEL,
            messages=[
                {"role": "system", "content": COMMON_PROMPT},
                {"role": "system", "content": unit_prompt},
                {"role": "system",
                 "content": "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ì•ì„œ ì–¸ê¸‰ëœ í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œ ì •ë¦¬í•´ ì£¼ì„¸ìš”."},
                {"role": "user",   "content": chunk}
            ]
        )
        summaries.append(resp.choices[0].message.content)
    return "\n\n".join(summaries)

# ===== Helpers =====
def clean_inline_latex(text):
    text = re.sub(r",\s*\\text\{(.*?)\}", r" \1", text)
    text = re.sub(r"\\text\{(.*?)\}", r"\1", text)
    text = re.sub(r"\\ce\{(.*?)\}", r"\1", text)
    text = re.sub(r"\\frac\{(.*?)\}\{(.*?)\}", r"\1/\2", text)
    text = re.sub(r"\\sqrt\{(.*?)\}", r"âˆš\1", text)
    text = re.sub(r"\\rightarrow", "â†’", text)
    text = re.sub(r"\\to", "â†’", text)
    text = re.sub(r"\^\{(.*?)\}", r"^\1", text)
    text = re.sub(r"_\{(.*?)\}", r"_\1", text)
    text = re.sub(r"\\", "", text)
    text = re.sub(r"\(\((.*?)\)\)", r"\1", text)
    text = re.sub(r"\b(times)\b", "Ã—", text)
    text = re.sub(r"\b(div|divided by)\b", "Ã·", text)
    text = re.sub(r"\b(plus)\b", "+", text)
    text = re.sub(r"\b(minus)\b", "-", text)
    text = re.sub(r"\^\s*\\circ", "Â°", text)
    text = re.sub(r"\^circ", "Â°", text)

    replacements = {
        r"\\perp": "âŸ‚",
        r"\\angle": "âˆ ",
        r"\\parallel": "âˆ¥",
        r"\\infty": "âˆ",
        r"\\approx": "â‰ˆ",
        r"\\sim": "âˆ¼",
        r"\\backsim": "âˆ½",
        r"\\neq": "â‰ ",
        r"\\leq": "â‰¤",
        r"\\geq": "â‰¥",
        r"\\pm": "Â±",
        r"\\mp": "âˆ“",
        r"\\cdot": "Â·",
        r"\\times": "Ã—",
        r"\\div": "Ã·",
        r"\\propto": "âˆ",
        r"\\equiv": "â‰¡",
        r"\\cong": "â‰…",
        r"\\subseteq": "âŠ†",
        r"\\supseteq": "âŠ‡",
        r"\\subset": "âŠ‚",
        r"\\supset": "âŠƒ",
        r"\\in": "âˆˆ",
        r"\\notin": "âˆ‰",
        r"\\cup": "âˆª",
        r"\\cap": "âˆ©",
        r"\\forall": "âˆ€",
        r"\\exists": "âˆƒ",
        r"\\nabla": "âˆ‡",
        r"\\partial": "âˆ‚",
    }
    for pattern, symbol in replacements.items():
        text = re.sub(pattern, symbol, text)

    text = re.sub(r"\bperp\b", "âŸ‚", text)
    text = re.sub(r"\bangle\b", "âˆ ", text)

    return text

# ===== LLM Router =====
ROUTER_SYS = """ë„ˆëŠ” ì¤‘í•™ìƒì˜ íŠœí„° ë¼ìš°í„°ë‹¤.
ì‚¬ìš©ì ì…ë ¥ê³¼ ì§ì „ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ë¥¼ ë³´ê³  ì•„ë˜ë¥¼ JSONìœ¼ë¡œë§Œ ì¶œë ¥í•œë‹¤.

intent:
- "request_problem" : ë¬¸ì œë¥¼ ë‚´ë‹¬ë¼ëŠ” ìš”ì²­
- "submit_answer"   : ì§ì „ ë¬¸ì œì— ëŒ€í•œ í•™ìƒì˜ ë‹µ ì œì¶œ(ìˆ«ì/ê¸°í˜¸/ì§§ì€ ë¬¸ì¥ í¬í•¨)
- "ask_explain"     : ì¼ë°˜ ì§ˆë¬¸/ì„¤ëª… ìš”ì²­ ë˜ëŠ” ì¼ìƒ ëŒ€í™”

needs_rag:
- true  : êµê³¼ì„œ ê·¼ê±°/ì •ì˜/ì›ë¬¸ ì¸ìš©ì´ í•„ìš”í•œ ê²½ìš°(ê°œë… í™•ì¸Â·ì •ì˜Â·ì •ë¦¬Â·ì˜ˆì‹œ ë“±)
- false : ì±„ì /ì •ì˜¤ íŒì •, ë‹¨ìˆœ ê³„ì‚°Â·ì¶”ë¡ , ì¼ìƒ ëŒ€í™”ì²˜ëŸ¼ êµê³¼ì„œê°€ ì—†ì–´ë„ ì¶©ë¶„í•œ ê²½ìš°

í˜•ì‹(ë°˜ë“œì‹œ JSONë§Œ):
{"intent":"request_problem|submit_answer|ask_explain", "needs_rag": true|false, "reason": "í•œì¤„ ê·¼ê±°"}
"""

def llm_route(user_text: str, last_assistant_msg: str | None) -> dict:
    """
    LLMì´ ì´ë²ˆ í„´ì˜ intent / needs_ragë¥¼ íŒë‹¨í•œë‹¤.
    ì‹¤íŒ¨ ì‹œ ask_explain/needs_rag=True ê¸°ë³¸ê°’ì„ ë°˜í™˜(ë³´ìˆ˜ì ).
    """
    import json, re
    msgs = [
        {"role": "system", "content": ROUTER_SYS},
        {"role": "user", "content":
            f"ì‚¬ìš©ì ì…ë ¥:\n{user_text}\n\nì§ì „ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€(ìš”ì•½ ê°€ëŠ¥):\n{(last_assistant_msg or 'ì—†ìŒ')[:1200]}"}
    ]
    try:
        r = client.chat.completions.create(model=MODEL, temperature=0, messages=msgs, max_tokens=160)
        raw = r.choices[0].message.content
        m = re.search(r"\{.*\}", raw, re.S)
        data = json.loads(m.group(0)) if m else {}
        if not isinstance(data, dict): raise ValueError("router non-dict")
        data.setdefault("intent", "ask_explain")
        data.setdefault("needs_rag", True)
        return data
    except Exception:
        return {"intent": "ask_explain", "needs_rag": True, "reason": "router_fallback"}

# RAG pipelines
def extract_text_from_pdf(path):
    if not os.path.exists(path):
        return ""
    doc = fitz.open(path)
    return "\n\n".join(page.get_text() for page in doc)

def chunk_text(text, size=1000):
    return [text[i:i+size] for i in range(0, len(text), size)]

def embed_texts(texts):
    if not texts:
        return []
    res = client.embeddings.create(
        model="text-embedding-3-small",
        input=texts
    )
    return [np.array(d.embedding) for d in res.data]

def get_relevant_chunks(question, chunks, embeddings, top_k=3):
    if not chunks:
        return []
    q_emb = np.array(
        client.embeddings.create(
            model="text-embedding-3-small", input=[question]
        ).data[0].embedding
    )
    sims = [np.dot(q_emb, emb)/(np.linalg.norm(q_emb)*np.linalg.norm(emb)) for emb in embeddings]
    idx = np.argsort(sims)[-top_k:][::-1]
    return [chunks[i] for i in idx]

# DB

def connect_to_db():
    return pymysql.connect(
        host=st.secrets["DB_HOST"],
        user=st.secrets["DB_USER"],
        password=st.secrets["DB_PASSWORD"],
        database=st.secrets["DB_DATABASE"],
        charset="utf8mb4",
        autocommit=True
    )

# === load_chat / save_chat ë§Œ êµì²´ ===

def load_chat(subject, topic):
    name = st.session_state.get("user_name", "").strip()
    code = st.session_state.get("user_code", "").strip()
    grade = subject.strip()
    subject_core = topic.strip()
    if not all([name, code]):
        return []
    try:
        db = connect_to_db(); cur = db.cursor()
        sql = (
            "SELECT chat FROM qna_unique_v4 "
            "WHERE name=%s AND code=%s AND grade=%s AND subject=%s"
        )
        cur.execute(sql, (name, code, grade, subject_core))
        row = cur.fetchone()
        cur.close(); db.close()
        return json.loads(row[0]) if row else []
    except Exception as e:
        st.error(f"DB ì˜¤ë¥˜: {e}")
        return []

def save_chat(subject, topic, chat):
    name = st.session_state.get("user_name", "").strip()
    code = st.session_state.get("user_code", "").strip()
    grade = subject.strip()
    subject_core = topic.strip()
    if not all([name, code]):
        return
    try:
        db = connect_to_db(); cur = db.cursor()
        sql = (
            "INSERT INTO qna_unique_v4 "
            "(name,code,grade,subject,chat,time) VALUES(%s,%s,%s,%s,%s,%s) "
            "ON DUPLICATE KEY UPDATE chat=VALUES(chat), time=VALUES(time)"
        )
        ts = datetime.now(ZoneInfo("Asia/Seoul"))
        cur.execute(sql, (
            name, code, grade, subject_core,
            json.dumps(chat, ensure_ascii=False), ts
        ))
        cur.close(); db.close()
    except Exception as e:
        st.error(f"DB ì˜¤ë¥˜: {e}")

# Spinner ì•„ì´ì½˜ ì •ì˜

def show_stage(message):
    st.markdown(f"""
    <div style='display: flex; align-items: center; font-size: 18px;'>
        <div class="loader" style="
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        "></div>
        <div>{message}</div>
    </div>

    <style>
    @keyframes spin {{
        0% {{ transform: rotate(0deg); }}
        100% {{ transform: rotate(360deg); }}
    }}
    </style>
    """, unsafe_allow_html=True)

# Chat UI

def chatbot_tab(subject, topic):
    key = f"chat_{subject}_{topic}".replace(" ", "_")
    load_key = f"loading_{key}"
    input_key = f"buffer_{key}"
    widget_key_base = f"textarea_{key}"

    # 1) ì„¸ì…˜ ì´ˆê¸°í™”
    if key not in st.session_state:
        st.session_state[key] = load_chat(subject, topic)
    if load_key not in st.session_state:
        st.session_state[load_key] = False
    msgs = st.session_state[key]

    # Select the appropriate science prompt for this unit
    unit_prompts = {
        "ê³¼í•™2(ë¹„ìƒ)": SCIENCE_08_PROMPT,
        "ê³¼í•™3(ë¹„ìƒ)": SCIENCE_09_PROMPT,
        "í†µí•©ê³¼í•™(ë™ì•„)": SCIENCE_10_PROMPT,
        "í†µí•©ê³¼í•™(ë¹„ìƒ)": SCIENCE_10_PROMPT,
    }
    selected_unit_prompt = unit_prompts.get(topic, "")

    # 2) ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§
    for msg in msgs:
        if msg["role"] == "user":
            st.write(f"**You:** {msg['content']}")
        else:
            parts = re.split(r"(@@@@@.*?@@@@@)", msg['content'], flags=re.DOTALL)
            for part in parts:
                if part.startswith("@@@@@") and part.endswith("@@@@@"):
                    st.latex(part[5:-5].strip())
                else:
                    txt = clean_inline_latex(part)
                    for link in re.findall(r"(https?://\S+\.(?:png|jpg))", txt):
                        st.image(link)
                        txt = txt.replace(link, "")
                    if txt.strip():
                        st.write(f"**í•™ìŠµ ë„ìš°ë¯¸:** {txt.strip()}")

    # 3) ì…ë ¥ì°½ & ë²„íŠ¼ (í† ê¸€ ë°©ì‹)
    placeholder = st.empty()
    if not st.session_state[load_key]:
        with placeholder.container():
            user_input = st.text_area("ì…ë ¥:", key=f"{widget_key_base}_{len(msgs)}")
            if st.button("ì „ì†¡", key=f"send_{key}_{len(msgs)}") and user_input.strip():
                st.session_state[input_key] = user_input.strip()
                st.session_state[load_key] = True
                st.rerun()

    # 4) ë¡œë”© ìƒíƒœì¼ ë•Œë§Œ OpenAI í˜¸ì¶œ (ë¼ìš°í„° â†’ RAG/ë¹„RAG ë¶„ê¸°)
    if st.session_state[load_key]:
        q = st.session_state.pop(input_key, "")
        if q:
            stage = st.empty()

            # 4-1) ì§ì „ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€(ë¬¸ì œ ì¶œì œ ì—¬ë¶€ ë“±) í™•ë³´
            last_assistant_msg = None
            for m in reversed(msgs):
                if m["role"] == "assistant":
                    last_assistant_msg = m["content"]
                    break

            # 4-2) LLM ë¼ìš°í„° í˜¸ì¶œ (ê·œì¹™ ì—†ì´ íŒë‹¨)
            decision = llm_route(q, last_assistant_msg)
            intent = decision.get("intent", "ask_explain")
            use_rag = bool(decision.get("needs_rag", True))

            # 4-3) ê³µí†µ ì‹œìŠ¤í…œ ë©”ì‹œì§€(ë¹„RAG/RAG ê³µí†µ)
            system_messages = [
                {"role": "system", "content": COMMON_PROMPT},
                {"role": "system", "content": selected_unit_prompt},
            ]
            history = [{"role": m["role"], "content": m["content"]} for m in msgs]

            # 4-4) ë¶„ê¸°: ë¹„RAG(ì±„ì /ì¼ìƒ ë“±) â†” RAG(êµê³¼ ê·¼ê±° í•„ìš”)
            if not use_rag:
                # ===== ë¹„RAG ê²½ë¡œ: êµê³¼ì„œ ê²€ìƒ‰/ì„ë² ë”© ìˆ˜í–‰ ê¸ˆì§€ =====
                stage.empty()
                show_stage("ë‹µë³€ ìƒì„± ì¤‘...")

                if intent == "submit_answer":
                    # ì±„ì  ì „ìš© í”„ë¡¬í”„íŠ¸ (ê°„ê²°)
                    judge_sys = (
                        "ë‹¹ì‹ ì€ ì¤‘í•™ìƒì˜ íŠœí„° ì±„ì ê´€ì…ë‹ˆë‹¤. í•™ìƒì˜ ë‹µì— ëŒ€í•´ ë‹¤ìŒ ì–‘ì‹ìœ¼ë¡œ ë‹µí•˜ì„¸ìš”.\n"
                        "1. í’€ì´ ê³¼ì • \n\n 2. íŒì •(ì •ë‹µ/ì˜¤ë‹µ) \n\n 3. í•œ ì¤„ í”¼ë“œë°±(ì˜¤ê°œë… êµì • ë˜ëŠ” í•™ìŠµ ì¡°ì–¸)\n\n"
                    )

                    prompt = system_messages + [
                        {"role": "system", "content": judge_sys},
                    ] + history + [
                        {"role": "user", "content": f"í•™ìƒ ë‹µ: {q}\nìƒëŒ€ ëŒ€í™” ë§¥ë½ì„ ê³ ë ¤í•´ ì±„ì /í”¼ë“œë°±ë§Œ ê°„ë‹¨íˆ ì œì‹œ."}
                    ]
                else:
                    # ì¼ìƒ ëŒ€í™”/ê°€ë²¼ìš´ ì§ˆë¬¸
                    smalltalk_sys = (
                        "ë‹¹ì‹ ì€ ì¹œê·¼í•œ íŠœí„°ì…ë‹ˆë‹¤. ì¼ìƒ ëŒ€í™”/ê°€ë²¼ìš´ ì§ˆë¬¸ì—ëŠ” "
                        "êµê³¼ì„œ ì¸ìš© ì—†ì´ í•œë‘ ë¬¸ì¥ìœ¼ë¡œ ê°„ë‹¨íˆ ë‹µí•©ë‹ˆë‹¤."
                    )

                    prompt = system_messages + [
                        {"role": "system", "content": smalltalk_sys},
                    ] + history + [
                        {"role": "user", "content": q}
                    ]

                resp = client.chat.completions.create(model=MODEL, messages=prompt)
                ans = resp.choices[0].message.content

            else:
                # ===== RAG ê²½ë¡œ: ì´ ë¸”ë¡ì—ì„œë§Œ êµê³¼ì„œ ê²€ìƒ‰/ì„ë² ë”© ìˆ˜í–‰ =====
                stage.empty()
                show_stage("êµê³¼ì„œ ê²€ìƒ‰ ì¤‘...")
                time.sleep(0.5)
                texts = [extract_text_from_pdf(os.path.join(BASE_DIR, fn)) for fn in PDF_MAP[topic]]
                full = "\n\n".join(texts)

                stage.empty()
                show_stage("ë‚´ìš© ë¶„ì„ ì¤‘...")
                time.sleep(0.5)
                chunks = chunk_text(full)
                embs = embed_texts(chunks)
                relevant = get_relevant_chunks(q, chunks, embs, top_k=3)[:3]

                stage.empty()
                show_stage("ë‹µë³€ ìƒì„± ì¤‘...")
                time.sleep(0.5)
                rag_system_message = {
                    "role": "system",
                    "content": (
                        "ì•„ë˜ ì²­í¬ë“¤ì€ êµê³¼ì„œì—ì„œ ë°œì·Œí•œ ë‚´ìš©ì…ë‹ˆë‹¤. "
                        "ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ì²­í¬ë§Œ ì°¸ê³ í•´ ë‹µë³€í•˜ì„¸ìš”. "
                        "ë‹µë³€ì‹œ êµê³¼ì„œì˜ í‘œí˜„ì„ ì² ì €í•˜ê²Œ ë°˜ì˜í•˜ì„¸ìš”:\n\n"
                        + "\n\n".join(relevant)
                    ),
                }
                prompt = system_messages + history + [rag_system_message, {"role": "user", "content": q}]
                resp = client.chat.completions.create(model=MODEL, messages=prompt)
                ans = resp.choices[0].message.content

            # 4-5) ê³µí†µ: ëŒ€í™” ì €ì¥ ë° ë¦¬ë Œë”
            stage.empty()
            ts = datetime.now(ZoneInfo("Asia/Seoul")).strftime("%Y-%m-%d %H:%M")
            msgs.extend(
                [
                    {"role": "user", "content": q, "timestamp": ts},
                    {"role": "assistant", "content": ans},
                ]
            )
            save_chat(subject, topic, msgs)
            st.session_state[key] = msgs
            st.session_state[load_key] = False
            st.rerun()

# ===== Pages =====
def page_1():
    st.title("ì´ê³³ì— ì œëª©ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì˜ˆ: í•™ì›ëª…..)")
    st.write("ì´ê³³ì— ë‚´ìš©ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì˜ˆ: ê°„ë‹¨í•œ í™ë³´ ë¬¸êµ¬, ì—°ë½ì²˜..)")
    st.session_state['user_name'] = st.text_input("ì´ë¦„", value=st.session_state.get('user_name',''))
    st.session_state['user_code'] = st.text_input("ì‹ë³„ì½”ë“œ", value=st.session_state.get('user_code',''),
        help="íƒ€ì¸ì˜ ì´ë¦„ìœ¼ë¡œ ì ‘ì†í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ìì‹ ë§Œ ê¸°ì–µí•  ìˆ˜ ìˆëŠ” ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
    st.markdown("> ğŸŒŸ â€œìƒê°í•˜ê±´ëŒ€ í˜„ì¬ì˜ ê³ ë‚œì€ ì¥ì°¨ ìš°ë¦¬ì—ê²Œ ë‚˜íƒ€ë‚  ì˜ê´‘ê³¼ ë¹„êµí•  ìˆ˜ ì—†ë„ë‹¤â€ â€” ë¡œë§ˆì„œ 8ì¥ 18ì ˆ")
    if st.button("ë‹¤ìŒ"):
        if not all([st.session_state['user_name'].strip(), st.session_state['user_code'].strip()]):
            st.error("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            st.session_state['step']=3; st.rerun()

def page_2(): # í˜„ì¬ ìƒëµë˜ì–´ ìˆìŒ
    st.title("âš ï¸ëª¨ë“  ëŒ€í™” ë‚´ìš©ì€ ì €ì¥ë˜ë©°, êµì‚¬ê°€ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    st.write(
       """  
        ì´ ì‹œìŠ¤í…œì€ í•™ìƒë“¤ì„ ìœ„í•œ AI í•™ìŠµ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
        """)
    col1, col2 = st.columns([1, 1])
    with col1:
        if st.button("ë‹¤ìŒ"):
            st.session_state["step"] = 3
            st.rerun()

def page_3():
    st.title("ê³¼ëª©ë³„ í•™ìŠµ")
    st.markdown("â— AIì˜ ë‹µë³€ì€ ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì„ ìƒë‹˜ê»˜ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.")

    default_subject = "í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”."
    subject = st.selectbox(
        "í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”.",
        [default_subject] + list(SUBJECTS.keys())
    )
    if subject == default_subject:
        return

    default_unit = "ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”."
    units = SUBJECTS[subject]
    unit = st.selectbox(
        "ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.",
        [default_unit] + units
    )
    if unit == default_unit:
        return

    # ë‹¨ì›ì´ ë°”ë€” ë•Œ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if "prev_unit" not in st.session_state:
        st.session_state["prev_unit"] = unit

    if unit != st.session_state["prev_unit"]:
        for k in list(st.session_state.keys()):
            if k.startswith("chat_") or k.startswith("buffer_") or k.startswith("loading_") or k.startswith("textarea_"):
                del st.session_state[k]
        st.session_state["prev_unit"] = unit

    chatbot_tab(subject, unit)

# ===== Routing =====
if 'step' not in st.session_state:
    st.session_state['step'] = 1
if st.session_state['step'] == 1:
    page_1()
elif st.session_state['step'] == 2:
    page_2()
else:
    page_3()